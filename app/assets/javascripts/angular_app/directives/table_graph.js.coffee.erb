angular.module('InescApp').directive 'tableGraph', ->
  calculateMonths = (entity) ->
    months = {}
    $.each entity.autorizado.drilldown, (i, element) ->
      months[element.time.month] ||= {label: element.time.month}
      months[element.time.month].autorizado = element.amount
    $.each entity.rppago.drilldown, (i, element) ->
      months[element.time.month] ||= {label: element.time.month}
      months[element.time.month].rppago = element.rppago
    $.each entity.pago.drilldown, (i, element) ->
      months[element.time.month] ||= {label: element.time.month}
      months[element.time.month].pago = element.pago
      months[element.time.month].pagamentos = element.pago + months[element.time.month].rppago
    months

  restrict: 'E',
  scope:
    entity: '=',
    totals: '=',
    year: '='
  templateUrl: '<%= asset_path("angular_app/templates/table_graph.html") %>'
  link: (scope, element, attributes) ->
    scope.$watch 'entity.autorizado', ->
      entity = scope.entity
      if entity? and entity.autorizado?
        scope.months = calculateMonths(entity)

